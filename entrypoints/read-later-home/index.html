<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ff7b72">
  <meta name="description" content="SideDoor 稍后阅读 - 离线优先的阅读体验">
  <title>SideDoor - 稍后阅读</title>
  <link rel="icon" type="image/png" href="/icon/128.png" />
  <link rel="manifest" href="/manifest.json" />
  <link rel="apple-touch-icon" href="/icon/128.png" />
</head>
<body>
  <div id="app"></div>
  <script type="module" src="./main.ts"></script>
  <script>
    // 注册 Service Worker (仅在非扩展环境)
    if ('serviceWorker' in navigator) {
      // 检查是否在扩展环境中
      const isExtension = !!(
        (typeof chrome !== 'undefined' && chrome.runtime && chrome.runtime.id) ||
        window.location.protocol === 'chrome-extension:' ||
        window.location.protocol === 'moz-extension:'
      );

      if (!isExtension) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js')
            .then(registration => {
              console.log('Service Worker 注册成功:', registration.scope);
              
              // 检查更新
              registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                if (newWorker) {
                  newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                      console.log('新的 Service Worker 可用，请刷新页面');
                      // 可以在这里显示更新提示
                    }
                  });
                }
              });
            })
            .catch(error => {
              console.error('Service Worker 注册失败:', error);
            });
        });
      } else {
        console.log('扩展环境检测到，跳过 Service Worker 注册');
      }
    }
  </script>
</body>
</html>
