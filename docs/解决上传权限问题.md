# 🔧 解决 "new row violates row-level security policy" 错误

## 问题说明

当你运行 `npm run upload:standalone` 时，看到这个错误：
```
❌ 上传失败: new row violates row-level security policy
```

这是因为 Supabase 的 **Row Level Security (RLS)** 策略默认不允许匿名用户上传文件到 Storage。

## ✅ 两种解决方案

---

### 方案 1：使用 Service Role Key（⭐ 推荐）

这种方式更安全，Service Role Key 只在本地使用，不会暴露在公开的网页中。

#### 步骤：

1. **获取 Service Role Key**
   
   - 打开浏览器，访问：https://app.supabase.com
   - 选择你的项目
   - 点击左下角 ⚙️ **Settings**
   - 点击 **API**
   - 在 "Project API keys" 部分找到 **service_role** （Secret）
   - 点击 👁️ 图标显示密钥
   - 点击 📋 复制密钥

2. **设置环境变量**

   打开终端，运行：
   ```bash
   export SUPABASE_SERVICE_ROLE_KEY="eyJhbGc...你的完整密钥"
   ```
   
   ⚠️ **注意**：
   - 替换为你实际的 service_role 密钥
   - 这个设置只在当前终端会话有效
   - 新开终端需要重新设置

3. **运行上传命令**
   
   ```bash
   npm run upload:standalone
   ```

4. **✅ 成功标志**
   
   应该看到：
   ```
   ✅ 部署成功！
   📍 稍后阅读主页 URL: https://...
   ```

#### 💡 永久设置（可选）

如果不想每次都手动设置环境变量，可以创建 `.env.local` 文件：

```bash
# 在项目根目录创建 .env.local 文件
echo 'SUPABASE_SERVICE_ROLE_KEY="你的service_role密钥"' > .env.local

# 以后运行时先加载环境变量
source .env.local && npm run upload:standalone
```

⚠️ **重要**：确保 `.env.local` 已添加到 `.gitignore`，不要提交到 Git！

---

### 方案 2：配置 Storage RLS 策略

这种方式允许任何人通过 API 上传文件到 `public-pages` bucket。如果是个人项目，问题不大。

#### 步骤：

1. **打开 SQL Editor**
   
   - 访问：https://app.supabase.com
   - 选择你的项目
   - 点击左侧 **SQL Editor** 图标（</> 符号）

2. **执行 SQL 脚本**
   
   - 点击右上角 **New query** 创建新查询
   - 打开项目中的文件：`sql/setup-storage-upload-policy.sql`
   - 复制文件中的所有 SQL 代码
   - 粘贴到 SQL Editor
   - 点击右下角绿色的 **Run** 按钮

3. **验证执行成功**
   
   应该看到类似：
   ```
   Success. No rows returned
   ```

4. **重新运行上传**
   
   ```bash
   npm run upload:standalone
   ```

---

## 📋 对比两种方案

| 特性 | 方案 1: Service Role Key | 方案 2: RLS 策略 |
|------|-------------------------|-----------------|
| 安全性 | ⭐⭐⭐⭐⭐ 高（密钥只在本地） | ⭐⭐⭐ 中（允许匿名上传） |
| 设置难度 | 简单（设置环境变量） | 中等（需要执行 SQL） |
| 是否需要每次设置 | 是（或使用 .env.local） | 否（一次性配置） |
| 推荐场景 | 个人项目、团队项目 | 纯个人项目 |

## ❓ 常见问题

### Q1: 找不到 service_role 密钥？

在 Supabase Dashboard → Settings → API → Project API keys 中，有两行：
- `anon` `public` - 这是匿名密钥（公开的）
- `service_role` `secret` - 这是服务密钥（⭐ 你要的就是这个）

### Q2: Service Role Key 是什么格式？

以 `eyJ` 开头的长字符串，类似：
```
eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBh...
```

### Q3: 设置环境变量后还是提示没有？

确保：
1. 引号内是完整的密钥（没有空格或换行）
2. 在设置环境变量的**同一个**终端窗口运行 npm 命令
3. 或者使用 `.env.local` 文件并执行 `source .env.local`

### Q4: 执行 SQL 脚本后还是失败？

可能是策略名称冲突，先删除旧策略：

```sql
-- 在 SQL Editor 中执行
DROP POLICY IF EXISTS "Allow public uploads to public-pages" ON storage.objects;
DROP POLICY IF EXISTS "Allow public updates to public-pages" ON storage.objects;
DROP POLICY IF EXISTS "Allow public deletes from public-pages" ON storage.objects;
DROP POLICY IF EXISTS "Allow public reads from public-pages" ON storage.objects;
```

然后重新执行 `setup-storage-upload-policy.sql`。

---

## 🎉 完成！

选择一种方案完成配置后，你应该可以成功运行：

```bash
npm run upload:standalone
```

并获得你的稍后阅读主页链接！🚀
