# ğŸ” è¯Šæ–­å¹¶è§£å†³ Storage ä¸Šä¼ é—®é¢˜

## å½“å‰é—®é¢˜

ä½ é‡åˆ°çš„é”™è¯¯ï¼š
```
Cannot convert argument to a ByteString because the character at index 10 has a value of 20320 which is greater than 255.
```

è¿™ä¸ªé”™è¯¯å¾ˆå¥‡æ€ªï¼Œå¯èƒ½æ˜¯ç”±äºï¼š
1. **RLS ç­–ç•¥é˜»æ­¢**äº†æ“ä½œï¼Œä½†é”™è¯¯ä¿¡æ¯æœ¬èº«æœ‰é—®é¢˜
2. Supabase SDK ç‰ˆæœ¬å…¼å®¹æ€§é—®é¢˜
3. ç¯å¢ƒé…ç½®é—®é¢˜

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆï¼šå…ˆè¿è¡Œè¯Šæ–­æµ‹è¯•

æˆ‘åˆ›å»ºäº†ä¸€ä¸ªè¯Šæ–­è„šæœ¬æ¥æµ‹è¯•ä½ çš„ Storage æƒé™ã€‚

### æ­¥éª¤ 1ï¼šä¸ä½¿ç”¨ Service Key æµ‹è¯•ï¼ˆéªŒè¯é—®é¢˜ï¼‰

```bash
npm run test:storage
```

è¿™ä¼šæµ‹è¯•ï¼š
- âœ“ èƒ½å¦åˆ—å‡º buckets
- âœ“ public-pages bucket æ˜¯å¦å­˜åœ¨
- âœ“ èƒ½å¦ä¸Šä¼ æ–‡ä»¶

**é¢„æœŸç»“æœ**ï¼šåº”è¯¥ä¼šåœ¨ä¸Šä¼ æµ‹è¯•æ—¶å¤±è´¥ï¼Œç¡®è®¤æ˜¯ RLS é—®é¢˜ã€‚

---

### æ­¥éª¤ 2ï¼šè·å– Service Role Key

1. **æ‰“å¼€ Supabase Dashboard**
   ```
   https://app.supabase.com
   ```

2. **å¯¼èˆªåˆ° API è®¾ç½®**
   - é€‰æ‹©ä½ çš„é¡¹ç›®ï¼ˆrimhmaeecdcrhuqbisjvï¼‰
   - ç‚¹å‡»å·¦ä¸‹è§’ âš™ï¸ **Settings**
   - ç‚¹å‡» **API**

3. **æ‰¾åˆ°å¹¶å¤åˆ¶ Service Role Key**
   - åœ¨ "Project API keys" éƒ¨åˆ†
   - æ‰¾åˆ°æ ‡æœ‰ **`service_role`** å’Œ **`secret`** çš„é‚£ä¸€è¡Œ
   - ç‚¹å‡» ğŸ‘ï¸ å›¾æ ‡æ˜¾ç¤ºå¯†é’¥
   - ç‚¹å‡» ğŸ“‹ å¤åˆ¶æ•´ä¸ªå¯†é’¥ï¼ˆä»¥ `eyJ` å¼€å¤´çš„é•¿å­—ç¬¦ä¸²ï¼‰

   âš ï¸ **é‡è¦**ï¼š
   - è¿™**ä¸æ˜¯** `anon` / `public` å¯†é’¥ï¼ˆé‚£ä¸ªæ˜¯ç»™æµè§ˆå™¨ç”¨çš„ï¼‰
   - service_role å¯†é’¥å…·æœ‰**ç®¡ç†å‘˜æƒé™**ï¼Œè¯·å¦¥å–„ä¿ç®¡
   - ä¸è¦æäº¤åˆ° Git æˆ–å…¬å¼€åˆ†äº«

---

### æ­¥éª¤ 3ï¼šä½¿ç”¨ Service Role Key å†æ¬¡æµ‹è¯•

```bash
export SUPABASE_SERVICE_ROLE_KEY="ç²˜è´´ä½ å¤åˆ¶çš„å¯†é’¥"
npm run test:storage
```

**é¢„æœŸç»“æœ**ï¼šæ‰€æœ‰æµ‹è¯•åº”è¯¥éƒ½é€šè¿‡ âœ…

---

### æ­¥éª¤ 4ï¼šä¸Šä¼ çœŸå®æ–‡ä»¶

å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œè¿è¡ŒçœŸæ­£çš„ä¸Šä¼ ï¼š

```bash
# Service Role Key ç¯å¢ƒå˜é‡è¿˜åœ¨å½“å‰ç»ˆç«¯
npm run upload:standalone
```

**é¢„æœŸç»“æœ**ï¼šæˆåŠŸä¸Šä¼ å¹¶æ˜¾ç¤º URL

---

## ğŸ“‹ å®Œæ•´çš„ä¸€æ¬¡æ€§å‘½ä»¤

å¦‚æœä½ æƒ³ä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰æ­¥éª¤ï¼š

```bash
# 1. è®¾ç½® Service Role Keyï¼ˆæ›¿æ¢ä¸ºä½ çš„çœŸå®å¯†é’¥ï¼‰
export SUPABASE_SERVICE_ROLE_KEY="eyJhbGc...ä½ çš„å®Œæ•´service_roleå¯†é’¥"

# 2. è¿è¡Œè¯Šæ–­æµ‹è¯•ï¼ˆå¯é€‰ï¼Œä½†æ¨èï¼‰
npm run test:storage

# 3. ä¸Šä¼ ç¨åé˜…è¯»ä¸»é¡µ
npm run upload:standalone
```

---

## ğŸ”§ å¤‡é€‰æ–¹æ¡ˆï¼šé…ç½® RLS ç­–ç•¥

å¦‚æœä½ ä¸æƒ³æ¯æ¬¡éƒ½è®¾ç½®ç¯å¢ƒå˜é‡ï¼Œå¯ä»¥é…ç½® Storage RLS ç­–ç•¥ï¼ˆä¸€æ¬¡æ€§ï¼‰ï¼š

### æ­¥éª¤ï¼š

1. **æ‰“å¼€ SQL Editor**
   - Supabase Dashboard â†’ SQL Editor
   - ç‚¹å‡» "New query"

2. **æ‰§è¡Œç­–ç•¥é…ç½®**
   
   æ‰“å¼€é¡¹ç›®ä¸­çš„ `sql/setup-storage-upload-policy.sql` æ–‡ä»¶ï¼Œå¤åˆ¶ä»¥ä¸‹å†…å®¹ï¼š

```sql
-- å…è®¸åŒ¿åç”¨æˆ·æ’å…¥ï¼ˆä¸Šä¼ ï¼‰æ–‡ä»¶åˆ° public-pages bucket
INSERT INTO storage.buckets (id, name, public)
VALUES ('public-pages', 'public-pages', true)
ON CONFLICT (id) DO UPDATE SET public = true;

-- åˆ›å»ºå…è®¸ä¸Šä¼ çš„ç­–ç•¥
CREATE POLICY "Allow public uploads to public-pages"
ON storage.objects
FOR INSERT
TO anon, authenticated
WITH CHECK (bucket_id = 'public-pages');

-- åˆ›å»ºå…è®¸æ›´æ–°ï¼ˆè¦†ç›–ï¼‰çš„ç­–ç•¥
CREATE POLICY "Allow public updates to public-pages"
ON storage.objects
FOR UPDATE
TO anon, authenticated
USING (bucket_id = 'public-pages')
WITH CHECK (bucket_id = 'public-pages');

-- åˆ›å»ºå…è®¸åˆ é™¤çš„ç­–ç•¥
CREATE POLICY "Allow public deletes from public-pages"
ON storage.objects
FOR DELETE
TO anon, authenticated
USING (bucket_id = 'public-pages');

-- åˆ›å»ºå…è®¸è¯»å–çš„ç­–ç•¥
CREATE POLICY "Allow public reads from public-pages"
ON storage.objects
FOR SELECT
TO anon, authenticated
USING (bucket_id = 'public-pages');
```

3. **ç‚¹å‡» Run æ‰§è¡Œ**

4. **é‡æ–°æµ‹è¯•**
   ```bash
   # ä¸éœ€è¦ Service Role Key äº†
   npm run test:storage
   npm run upload:standalone
   ```

---

## â“ å¸¸è§é—®é¢˜

### Q: æˆ‘æ‰¾ä¸åˆ° service_role å¯†é’¥

A: åœ¨ Settings â†’ API é¡µé¢ï¼Œæœ‰ä¸¤è¡Œå¯†é’¥ï¼š
- ç¬¬ä¸€è¡Œï¼š`anon` `public` - âŒ ä¸æ˜¯è¿™ä¸ª
- ç¬¬äºŒè¡Œï¼š`service_role` `secret` - âœ… å°±æ˜¯è¿™ä¸ª

### Q: è®¾ç½®äº†ç¯å¢ƒå˜é‡è¿˜æ˜¯æŠ¥é”™

A: ç¡®ä¿ï¼š
1. åœ¨è®¾ç½®ç¯å¢ƒå˜é‡çš„**åŒä¸€ä¸ªç»ˆç«¯çª—å£**è¿è¡Œå‘½ä»¤
2. å¯†é’¥æ˜¯å®Œæ•´çš„ï¼ˆæ²¡æœ‰ç©ºæ ¼æˆ–æ¢è¡Œï¼‰
3. å¯†é’¥ä»¥ `eyJ` å¼€å¤´

éªŒè¯æ˜¯å¦è®¾ç½®æˆåŠŸï¼š
```bash
echo $SUPABASE_SERVICE_ROLE_KEY
```
åº”è¯¥æ˜¾ç¤ºä½ çš„å¯†é’¥ã€‚

### Q: æ‰§è¡Œ SQL åè¿˜æ˜¯å¤±è´¥

A: å¯èƒ½æ˜¯ç­–ç•¥åç§°å†²çªã€‚å…ˆåˆ é™¤æ—§ç­–ç•¥ï¼š

```sql
DROP POLICY IF EXISTS "Allow public uploads to public-pages" ON storage.objects;
DROP POLICY IF EXISTS "Allow public updates to public-pages" ON storage.objects;
DROP POLICY IF EXISTS "Allow public deletes from public-pages" ON storage.objects;
DROP POLICY IF EXISTS "Allow public reads from public-pages" ON storage.objects;
```

ç„¶åé‡æ–°æ‰§è¡Œåˆ›å»ºç­–ç•¥çš„ SQLã€‚

---

## ğŸ“Š æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | Service Role Key | RLS ç­–ç•¥é…ç½® |
|------|-----------------|-------------|
| è®¾ç½®éš¾åº¦ | â­â­ ç®€å• | â­â­â­ ä¸­ç­‰ |
| å®‰å…¨æ€§ | â­â­â­â­â­ é«˜ | â­â­â­ ä¸­ |
| æ˜¯å¦éœ€è¦æ¯æ¬¡è®¾ç½® | æ˜¯ï¼ˆæˆ–ç”¨ .envï¼‰ | å¦ |
| æ¨èåœºæ™¯ | ä¸ªäºº/å›¢é˜Ÿé¡¹ç›® | çº¯ä¸ªäººé¡¹ç›® |

---

## ğŸ¯ ç°åœ¨å¼€å§‹

**æ¨èæµç¨‹**ï¼š

1. å…ˆè¿è¡Œ `npm run test:storage` ç¡®è®¤é—®é¢˜
2. è·å– Service Role Key
3. è¿è¡Œ `export SUPABASE_SERVICE_ROLE_KEY="..."`
4. å†æ¬¡è¿è¡Œ `npm run test:storage` ç¡®è®¤ä¿®å¤
5. è¿è¡Œ `npm run upload:standalone` å®Œæˆä¸Šä¼ 

**5åˆ†é’Ÿæå®šï¼** ğŸš€
